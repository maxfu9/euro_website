{% extends "templates/web.html" %}
{% block page_content %}
{% if redirect_to %}
  <meta http-equiv="refresh" content="0; url={{ redirect_to }}">
  <script>window.location.href = "{{ redirect_to }}";</script>
{% endif %}
<section class="page-hero">
  <div class="container">
    <p class="eyebrow">Account</p>
    <h1>Sign in to Euro Plast.</h1>
    <p class="lead">Access your orders, invoices, and portal in one place.</p>
  </div>
</section>

<section class="section">
  <div class="container login-grid">
    <form class="login-card" id="login-form" method="post" action="javascript:void(0)" onsubmit="return false;">
      <div class="login-header">
        <h2>Welcome back</h2>
        <p class="muted">Sign in to manage orders, invoices, and approvals.</p>
      </div>
      <label>Email</label>
      <input type="email" name="login_email" placeholder="you@company.com" required />
      <label>Password</label>
      <div class="password-field">
        <input type="password" name="login_password" placeholder="Your password" required />
        <button class="password-toggle" type="button" data-toggle-password aria-label="Show password">
          <i class="fa-regular fa-eye" aria-hidden="true"></i>
        </button>
      </div>
      <button class="btn btn-solid btn-large" type="submit">Sign in</button>
      <div class="form-note" id="login-status"></div>
      <div class="login-links">
        <a class="row-link" href="/signup">Create an account</a>
        <a class="row-link" href="/signup?type=trader">Apply for wholesale</a>
      </div>
    </form>
    <div class="login-benefits">
      <h3>New customer?</h3>
      <p>Create an account to track orders, manage invoices, and request trader pricing.</p>
      <ul class="benefit-list">
        <li>Track orders and payments</li>
        <li>Save addresses for faster checkout</li>
        <li>Request wholesale approval</li>
      </ul>
      <a class="btn btn-ghost" href="/signup">Sign up</a>
    </div>
  </div>
</section>
<script>
  (function () {
    document.querySelectorAll("[data-toggle-password]").forEach((button) => {
      button.addEventListener("click", () => {
        const wrapper = button.closest(".password-field");
        const input = wrapper?.querySelector("input");
        if (!input) return;
        const isHidden = input.type === "password";
        input.type = isHidden ? "text" : "password";
        button.setAttribute("aria-label", isHidden ? "Hide password" : "Show password");
        const icon = button.querySelector("i");
        if (icon) {
          icon.classList.remove("fa-eye", "fa-eye-slash");
          icon.classList.add(isHidden ? "fa-eye-slash" : "fa-eye");
        }
      });
    });
    const form = document.getElementById("login-form");
    if (!form || form.dataset.bound) return;
    form.dataset.bound = "1";
    form.addEventListener("submit", async (event) => {
      event.preventDefault();
      const status = document.getElementById("login-status");
      if (status) status.textContent = "Signing in...";
      try {
        const response = await fetch("/api/method/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            usr: form.login_email?.value || "",
            pwd: form.login_password?.value || "",
          }),
          credentials: "same-origin",
        });
        const result = await response.json();
        if (result.message === "Logged In" || result.home_page) {
          let user = "Guest";
          try {
            const userResp = await fetch("/api/method/frappe.auth.get_logged_user", {
              credentials: "same-origin",
            });
            const userData = await userResp.json();
            user = userData?.message || "Guest";
          } catch (e) {}
          let redirect = "/portal";
          if (user && user !== "Guest") {
            try {
              const metaResp = await fetch(`/api/resource/User/${encodeURIComponent(user)}`, {
                credentials: "same-origin",
              });
              const meta = await metaResp.json();
              if (meta?.data?.user_type === "System User") redirect = "/app";
            } catch (e) {}
          }
          window.location.href = redirect;
        } else if (status) {
          status.textContent = "Invalid credentials. Try again.";
        }
      } catch (e) {
        if (status) status.textContent = "Unable to sign in. Try again.";
      }
    });
  })();
</script>

{% endblock %}
